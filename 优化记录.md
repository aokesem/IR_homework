# RAG 系统优化记录

本项目优化过程中所有重大修改的记录，方便后续审计与学习。

---

## 🟢 2025-12-26: 实现多轮对话功能 (Multi-turn Chat)

### 1. 修改说明
将系统从单次问答模式升级为具备上下文记忆的对话模式。

### 2. 核心改动
*   **src/generator.py**:
    *   `generate` 方法新增 `history` 参数。
    *   **逻辑**: 将 `[[问题, 回答], ...]` 格式的历史记录注入到模型的 Prompt 中。对于 Instruct 模型，使用 Chat Template 维护消息序列；对于基础模型，采用文本拼接。
*   **src/rag_system.py**:
    *   `query` 方法新增 `history` 参数，并透传给生成器。
*   **app.py**:
    *   **UI 升级**: 将 `gr.Textbox` (输出) 替换为 `gr.Chatbot` 组件。
    *   **状态管理**: 利用 Gradio 内部状态维护对话流。
    *   **交互优化**: 加入了“清空对话”按钮和回车提交功能。

### 3. 后续扩展性
*   已预留接口，支持未来切换至具备更长上下文窗口的模型。
---

## 🔵 2025-12-26: 引用来源绑定与对话持久化 (Source Binding & Persistence)

### 1. 修改说明
解决“来源显示不固定”和“对话无法保存”的问题。

### 2. 核心改动
*   **引用绑定到消息**:
    - 修改 `app.py`: 将参考资料格式化为 HTML `<details>` 标签，直接追加到模型回答的末尾。
    - **效果**: 用户可以随时回溯查看历史对话中每一条回复的具体参考来源，互不干扰。
*   **持久化存储**:
    - **存储引擎**: 在 `data/conversations/` 下保存 JSON 文件。
    - **会话管理**: 引入 `current_chat_file` 机制，确保同一场对话保存在同一个文件中，避免产生大量碎片文件。
    - **前端管理**: 增加了“历史对话”下拉菜单和刷新按钮（🔄），支持随时载入旧对话。
*   **配置更新**:
    - `config.yaml`: 新增 `paths.conversations` 配置项。

### 3. 技术细节
*   利用 Gradio 的 `gr.Dropdown` 和事件监听实现历史记录的动态加载。
---

## 🟠 2025-12-26: 实现解析数据缓存 (Parsing Cache)

### 1. 修改说明
针对大型 PDF/Word 文档解析缓慢的问题，实现了一种基于文件的预处理缓存机制。

### 2. 核心改动
*   **src/document_processor.py**:
    - **逻辑增强**: 在加载文件前，先计算 `data/processed/` 下对应的 `.json` 缓存路径。
    - **合法性校验**: 缓存文件中记录了原始文件的 `mtime` (修改时间)。若原始未变动，则直接秒开缓存；若原始已变动，则触发布量更新并重写缓存。
    - **自动化**: 在 `process_directory` 流程中无缝集成。
*   **src/rag_system.py**:
    - 将配置中的 `processed_docs` 路径正确传递给处理器。

### 3. 性能表现
*   **冷启动**: 正常解析，生成缓存（首次较慢）。
---

## 🎨 2025-12-26: UI 定制化与知识库透明化 (UI Customization & KB Visibility)

### 1. 修改说明
提升用户对 RAG 系统的控制感和透明度，支持实时调整指令策略并查看后台数据。

### 2. 核心改动
*   **Prompt 自由定制**:
    - **前端**: 在问答页增加“高级设置”折叠面板，提供全量 Prompt 模板编辑框。
    - **后端**: `generator.py` 和 `rag_system.py` 适配动态参数，支持提问时覆盖默认指令。
*   **知识库内容可视化**:
    - **功能**: 在“文档管理”页增加实时数据表格。
    - **技术**: 深入 `FAISS` 的 `docstore` 提取元数据，统计每个文件的分片（Chunk）数量。
    - **联动**: 上传文件或重新构建索引后，表格会自动同步刷新。

### 3. 使用场景
*   **Prompt 调优**: 通过修改模板，可以强制模型用特定格式（如 JSON、表格）或特定语言回答。
*   **数据检查**: 确认文件是否被正确切分并存入向量库，避免“盲盒”式检索。

---

## 🧪 2025-12-26: 构建 Ragas 评测框架 (Evaluation Framework)

### 1. 修改说明
只有可量化，才能谈优化。建立了一套自动化的 RAG 评测流程。

### 2. 核心组件
*   **evaluation/test_dataset.json**:
    - 存储“考卷”，即标准问题与其对应的 Ground Truth（参考答案）。
*   **evaluation/evaluate_rag.py**:
    - **自动化流水线**: 自动读取考卷 -> 驱动 RAG 系统生成答案 -> 抓取检索到的 Context -> 将所有结果汇总。
    - **Ragas 接口**: 预留了 Ragas 打分接口，待确定“裁判模型”后即可一键生成报表。

### 3. 研究意义
*   将项目从“调库”向“对比实验”转型。
*   支持对不同分块策略（Chunk Size）、检索算法（BM25 vs Vector）进行横向跑分对比。

---
